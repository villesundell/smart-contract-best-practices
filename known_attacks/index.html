



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://github.com/ConsenSys/smart-contract-best-practices/known_attacks/">
      
      
        <meta name="author" content="ConsenSys">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.2.5">
    
    
      
        <title>Known Attacks - Ethereum Smart Contract Best Practices</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.bcabdff3.css">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    
  </head>
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://github.com/ConsenSys/smart-contract-best-practices" title="Ethereum Smart Contract Best Practices" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Ethereum Smart Contract Best Practices
              </span>
              <span class="md-header-nav__topic">
                Known Attacks
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/ConsenSys/smart-contract-best-practices/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    Ethereum Smart Contract Best Practices
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/ConsenSys/smart-contract-best-practices/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../general_philosophy/" title="General Philosophy" class="md-nav__link">
      General Philosophy
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../recommendations/" title="Solidity Recommendations" class="md-nav__link">
      Solidity Recommendations
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Known Attacks
      </label>
    
    <a href="./" title="Known Attacks" class="md-nav__link md-nav__link--active">
      Known Attacks
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reentrancy" title="Reentrancy" class="md-nav__link">
    Reentrancy
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reentrancy-on-a-single-function" title="Reentrancy on a Single Function" class="md-nav__link">
    Reentrancy on a Single Function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-function-reentrancy" title="Cross-function Reentrancy" class="md-nav__link">
    Cross-function Reentrancy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pitfalls-in-reentrancy-solutions" title="Pitfalls in Reentrancy Solutions" class="md-nav__link">
    Pitfalls in Reentrancy Solutions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#front-running-aka-transaction-ordering-dependence" title="Front-Running (AKA Transaction-Ordering Dependence)" class="md-nav__link">
    Front-Running (AKA Transaction-Ordering Dependence)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#timestamp-dependence" title="Timestamp Dependence" class="md-nav__link">
    Timestamp Dependence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integer-overflow-and-underflow" title="Integer Overflow and Underflow" class="md-nav__link">
    Integer Overflow and Underflow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#underflow-in-depth-storage-manipulation" title="Underflow in Depth: Storage Manipulation" class="md-nav__link">
    Underflow in Depth: Storage Manipulation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dos-with-unexpected-revert" title="DoS with (Unexpected) revert" class="md-nav__link">
    DoS with (Unexpected) revert
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dos-with-block-gas-limit" title="DoS with Block Gas Limit" class="md-nav__link">
    DoS with Block Gas Limit
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gas-limit-dos-on-a-contract-via-unbounded-operations" title="Gas Limit DoS on a Contract via Unbounded Operations" class="md-nav__link">
    Gas Limit DoS on a Contract via Unbounded Operations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gas-limit-dos-on-the-network-via-block-stuffing" title="Gas Limit DoS on the Network via Block Stuffing" class="md-nav__link">
    Gas Limit DoS on the Network via Block Stuffing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#insufficient-gas-griefing" title="Insufficient gas griefing" class="md-nav__link">
    Insufficient gas griefing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#forcibly-sending-ether-to-a-contract" title="Forcibly Sending Ether to a Contract" class="md-nav__link">
    Forcibly Sending Ether to a Contract
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deprecatedhistorical-attacks" title="Deprecated/historical attacks" class="md-nav__link">
    Deprecated/historical attacks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#call-depth-attack-deprecated" title="Call Depth Attack (deprecated)" class="md-nav__link">
    Call Depth Attack (deprecated)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constantinople-reentrancy-attack" title="Constantinople Reentrancy Attack" class="md-nav__link">
    Constantinople Reentrancy Attack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#other-vulnerabilities" title="Other Vulnerabilities" class="md-nav__link">
    Other Vulnerabilities
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../software_engineering/" title="Software Engineering Techniques" class="md-nav__link">
      Software Engineering Techniques
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tokens/" title="Token specific recommendations" class="md-nav__link">
      Token specific recommendations
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../documentation_procedures/" title="Documentation and Procedures" class="md-nav__link">
      Documentation and Procedures
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../security_tools/" title="Security Tools" class="md-nav__link">
      Security Tools
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../security_eips/" title="Security EIPs" class="md-nav__link">
      Security EIPs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../security_notifications/" title="Security Resources" class="md-nav__link">
      Security Resources
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../bug_bounty_list/" title="Bug Bounty Programs" class="md-nav__link">
      Bug Bounty Programs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12">
    
    <label class="md-nav__link" for="nav-12">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../about/reviewers/" title="Reviewers" class="md-nav__link">
      Reviewers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../about/license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../about/contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reentrancy" title="Reentrancy" class="md-nav__link">
    Reentrancy
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reentrancy-on-a-single-function" title="Reentrancy on a Single Function" class="md-nav__link">
    Reentrancy on a Single Function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-function-reentrancy" title="Cross-function Reentrancy" class="md-nav__link">
    Cross-function Reentrancy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pitfalls-in-reentrancy-solutions" title="Pitfalls in Reentrancy Solutions" class="md-nav__link">
    Pitfalls in Reentrancy Solutions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#front-running-aka-transaction-ordering-dependence" title="Front-Running (AKA Transaction-Ordering Dependence)" class="md-nav__link">
    Front-Running (AKA Transaction-Ordering Dependence)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#timestamp-dependence" title="Timestamp Dependence" class="md-nav__link">
    Timestamp Dependence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integer-overflow-and-underflow" title="Integer Overflow and Underflow" class="md-nav__link">
    Integer Overflow and Underflow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#underflow-in-depth-storage-manipulation" title="Underflow in Depth: Storage Manipulation" class="md-nav__link">
    Underflow in Depth: Storage Manipulation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dos-with-unexpected-revert" title="DoS with (Unexpected) revert" class="md-nav__link">
    DoS with (Unexpected) revert
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dos-with-block-gas-limit" title="DoS with Block Gas Limit" class="md-nav__link">
    DoS with Block Gas Limit
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gas-limit-dos-on-a-contract-via-unbounded-operations" title="Gas Limit DoS on a Contract via Unbounded Operations" class="md-nav__link">
    Gas Limit DoS on a Contract via Unbounded Operations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gas-limit-dos-on-the-network-via-block-stuffing" title="Gas Limit DoS on the Network via Block Stuffing" class="md-nav__link">
    Gas Limit DoS on the Network via Block Stuffing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#insufficient-gas-griefing" title="Insufficient gas griefing" class="md-nav__link">
    Insufficient gas griefing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#forcibly-sending-ether-to-a-contract" title="Forcibly Sending Ether to a Contract" class="md-nav__link">
    Forcibly Sending Ether to a Contract
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deprecatedhistorical-attacks" title="Deprecated/historical attacks" class="md-nav__link">
    Deprecated/historical attacks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#call-depth-attack-deprecated" title="Call Depth Attack (deprecated)" class="md-nav__link">
    Call Depth Attack (deprecated)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constantinople-reentrancy-attack" title="Constantinople Reentrancy Attack" class="md-nav__link">
    Constantinople Reentrancy Attack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#other-vulnerabilities" title="Other Vulnerabilities" class="md-nav__link">
    Other Vulnerabilities
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ConsenSys/smart-contract-best-practices/edit/master/docs/known_attacks.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Known Attacks</h1>
                
                <p>The following is a list of known attacks which you should be aware of, and defend against when writing smart contracts.</p>
<h2 id="reentrancy">Reentrancy<a class="headerlink" href="#reentrancy" title="Permanent link">&para;</a></h2>
<p>One of the major dangers of <a href="../recommendations#external-calls">calling external contracts</a> is that they can take over the control flow, and make changes to your data that the calling function wasn't expecting. This class of bug can take many forms, and both of the major bugs that led to the DAO's collapse were bugs of this sort.</p>
<h3 id="reentrancy-on-a-single-function">Reentrancy on a Single Function<a class="headerlink" href="#reentrancy-on-a-single-function" title="Permanent link">&para;</a></h3>
<p>The first version of this bug to be noticed involved functions that could be called repeatedly, before the first invocation of the function was finished. This may cause the different invocations of the function to interact in destructive ways.</p>
<div class="highlight"><pre><span></span><span class="c1">// INSECURE</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">userBalances</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">withdrawBalance</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">amountToWithdraw</span> <span class="o">=</span> <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">];</span>
    <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">amountToWithdraw</span><span class="p">)(</span><span class="s">&quot;&quot;</span><span class="p">);</span> <span class="c1">// At this point, the caller&#39;s code is executed, and can call withdrawBalance again</span>
    <span class="n">require</span><span class="p">(</span><span class="n">success</span><span class="p">);</span>
    <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Since the user's balance is not set to 0 until the very end of the function, the second (and later) invocations will still succeed, and will withdraw the balance over and over again.</p>
<div class="admonition factoid">
<p class="admonition-title">Factoid</p>
<p>A DAO is a Decentralized Autonomous Organization. Its goal is to codify the rules and decisionmaking apparatus of an organization, eliminating the need for documents and people in governing, creating a structure with decentralized control.</p>
<p>On June 17<sup>th</sup> 2016, <a href="https://www.coindesk.com/understanding-dao-hack-journalists">The DAO</a> was hacked and 3.6 million Ether ($50 Million) were stolen using the first reentrancy attack.</p>
<p>Ethereum Foundation issued a critical update to rollback the hack. This resulted in Ethereum being forked into Ethereum Classic and Ethereum.</p>
</div>
<p>In the example given, the best way to prevent this attack is to make sure you don't call an external function until you've done all the internal work you need to do:</p>
<div class="highlight"><pre><span></span><span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">userBalances</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">withdrawBalance</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">amountToWithdraw</span> <span class="o">=</span> <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">];</span>
    <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">amountToWithdraw</span><span class="p">)(</span><span class="s">&quot;&quot;</span><span class="p">);</span> <span class="c1">// The user&#39;s balance is already 0, so future invocations won&#39;t withdraw anything</span>
    <span class="n">require</span><span class="p">(</span><span class="n">success</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Note that if you had another function which called <code>withdrawBalance()</code>, it would be potentially subject to the same attack, so you must treat any function which calls an untrusted contract as itself untrusted. See below for further discussion of potential solutions.</p>
<h3 id="cross-function-reentrancy">Cross-function Reentrancy<a class="headerlink" href="#cross-function-reentrancy" title="Permanent link">&para;</a></h3>
<p>An attacker may also be able to do a similar attack using two different functions that share the same state.</p>
<div class="highlight"><pre><span></span><span class="c1">// INSECURE</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">userBalances</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">userBalances</span><span class="p">[</span><span class="n">to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
       <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">withdrawBalance</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">amountToWithdraw</span> <span class="o">=</span> <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">];</span>
    <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">amountToWithdraw</span><span class="p">)(</span><span class="s">&quot;&quot;</span><span class="p">);</span> <span class="c1">// At this point, the caller&#39;s code is executed, and can call transfer()</span>
    <span class="n">require</span><span class="p">(</span><span class="n">success</span><span class="p">);</span>
    <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>In this case, the attacker calls <code>transfer()</code> when their code is executed on the external call in <code>withdrawBalance</code>. Since their balance has not yet been set to 0, they are able to transfer the tokens even though they already received the withdrawal. This vulnerability was also used in the DAO attack.</p>
<p>The same solutions will work, with the same caveats. Also note that in this example, both functions were part of the same contract. However, the same bug can occur across multiple contracts, if those contracts share state.</p>
<h3 id="pitfalls-in-reentrancy-solutions">Pitfalls in Reentrancy Solutions<a class="headerlink" href="#pitfalls-in-reentrancy-solutions" title="Permanent link">&para;</a></h3>
<p>Since reentrancy can occur across multiple functions, and even multiple contracts, any solution aimed at preventing reentrancy with a single function will not be sufficient.</p>
<p>Instead, <strong>we have recommended finishing all internal work (ie. state changes) first, and only then calling the external function</strong>. This rule, if followed carefully, will allow you to avoid vulnerabilities due to reentrancy. However, you need to not only avoid calling external functions too soon, but also avoid calling functions which call external functions. For example, the following is insecure:</p>
<div class="highlight"><pre><span></span><span class="c1">// INSECURE</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">userBalances</span><span class="p">;</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">)</span> <span class="kr">private</span> <span class="n">claimedBonus</span><span class="p">;</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">rewardsForA</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">withdrawReward</span><span class="p">(</span><span class="kt">address</span> <span class="n">recipient</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">amountToWithdraw</span> <span class="o">=</span> <span class="n">rewardsForA</span><span class="p">[</span><span class="n">recipient</span><span class="p">];</span>
    <span class="n">rewardsForA</span><span class="p">[</span><span class="n">recipient</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">recipient</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">amountToWithdraw</span><span class="p">)(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">require</span><span class="p">(</span><span class="n">success</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">getFirstWithdrawalBonus</span><span class="p">(</span><span class="kt">address</span> <span class="n">recipient</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="n">require</span><span class="p">(</span><span class="o">!</span><span class="n">claimedBonus</span><span class="p">[</span><span class="n">recipient</span><span class="p">]);</span> <span class="c1">// Each recipient should only be able to claim the bonus once</span>

    <span class="n">rewardsForA</span><span class="p">[</span><span class="n">recipient</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">withdrawReward</span><span class="p">(</span><span class="n">recipient</span><span class="p">);</span> <span class="c1">// At this point, the caller will be able to execute getFirstWithdrawalBonus again.</span>
    <span class="n">claimedBonus</span><span class="p">[</span><span class="n">recipient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Even though <code>getFirstWithdrawalBonus()</code> doesn't directly call an external contract, the call in <code>withdrawReward()</code> is enough to make it vulnerable to a reentrancy. You therefore need to treat <code>withdrawReward()</code> as if it were also untrusted.</p>
<div class="highlight"><pre><span></span><span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">userBalances</span><span class="p">;</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">)</span> <span class="kr">private</span> <span class="n">claimedBonus</span><span class="p">;</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">rewardsForA</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">untrustedWithdrawReward</span><span class="p">(</span><span class="kt">address</span> <span class="n">recipient</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">amountToWithdraw</span> <span class="o">=</span> <span class="n">rewardsForA</span><span class="p">[</span><span class="n">recipient</span><span class="p">];</span>
    <span class="n">rewardsForA</span><span class="p">[</span><span class="n">recipient</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">recipient</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">amountToWithdraw</span><span class="p">)(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">require</span><span class="p">(</span><span class="n">success</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">untrustedGetFirstWithdrawalBonus</span><span class="p">(</span><span class="kt">address</span> <span class="n">recipient</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="n">require</span><span class="p">(</span><span class="o">!</span><span class="n">claimedBonus</span><span class="p">[</span><span class="n">recipient</span><span class="p">]);</span> <span class="c1">// Each recipient should only be able to claim the bonus once</span>

    <span class="n">claimedBonus</span><span class="p">[</span><span class="n">recipient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="n">rewardsForA</span><span class="p">[</span><span class="n">recipient</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">untrustedWithdrawReward</span><span class="p">(</span><span class="n">recipient</span><span class="p">);</span> <span class="c1">// claimedBonus has been set to true, so reentry is impossible</span>
<span class="p">}</span>
</pre></div>

<p>In addition to the fix making reentry impossible, <a href="../recommendations#mark-untrusted-contracts">untrusted functions have been marked</a>. This same pattern repeats at every level: since <code>untrustedGetFirstWithdrawalBonus()</code> calls <code>untrustedWithdrawReward()</code>, which calls an external contract, you must also treat <code>untrustedGetFirstWithdrawalBonus()</code> as insecure.</p>
<p>Another solution often suggested is a <a href="https://en.wikipedia.org/wiki/Mutual_exclusion">mutex</a>. This allows you to "lock" some state so it can only be changed by the owner of the lock. A simple example might look like this:</p>
<div class="highlight"><pre><span></span><span class="c1">// Note: This is a rudimentary example, and mutexes are particularly useful where there is substantial logic and/or shared state</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">balances</span><span class="p">;</span>
<span class="kt">bool</span> <span class="kr">private</span> <span class="n">lockBalances</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">deposit</span><span class="p">()</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">require</span><span class="p">(</span><span class="o">!</span><span class="n">lockBalances</span><span class="p">);</span>
    <span class="n">lockBalances</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
    <span class="n">lockBalances</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">withdraw</span><span class="p">(</span><span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">require</span><span class="p">(</span><span class="o">!</span><span class="n">lockBalances</span> <span class="o">&amp;&amp;</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">);</span>
    <span class="n">lockBalances</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="nb">call</span><span class="p">(</span><span class="n">amount</span><span class="p">)(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Normally insecure, but the mutex saves it</span>
      <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">lockBalances</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>If the user tries to call <code>withdraw()</code> again before the first call finishes, the lock will prevent it from having any effect. This can be an effective pattern, but it gets tricky when you have multiple contracts that need to cooperate. The following is insecure:</p>
<div class="highlight"><pre><span></span><span class="c1">// INSECURE</span>
<span class="kd">contract</span> <span class="n">StateHolder</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="kr">private</span> <span class="n">n</span><span class="p">;</span>
    <span class="kt">address</span> <span class="kr">private</span> <span class="n">lockHolder</span><span class="p">;</span>

    <span class="kd">function</span> <span class="n">getLock</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="n">lockHolder</span> <span class="o">==</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="n">lockHolder</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">releaseLock</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span> <span class="o">==</span> <span class="n">lockHolder</span><span class="p">);</span>
        <span class="n">lockHolder</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">set</span><span class="p">(</span><span class="kt">uint</span> <span class="n">newState</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span> <span class="o">==</span> <span class="n">lockHolder</span><span class="p">);</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">newState</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>An attacker can call <code>getLock()</code>, and then never call <code>releaseLock()</code>. If they do this, then the contract will be locked forever, and no further changes will be able to be made. If you use mutexes to protect against reentrancy, you will need to carefully ensure that there are no ways for a lock to be claimed and never released. (There are other potential dangers when programming with mutexes, such as deadlocks and livelocks. You should consult the large amount of literature already written on mutexes, if you decide to go this route.)</p>
<hr />
<h2 id="front-running-aka-transaction-ordering-dependence">Front-Running (AKA Transaction-Ordering Dependence)<a class="headerlink" href="#front-running-aka-transaction-ordering-dependence" title="Permanent link">&para;</a></h2>
<p>Above were examples of reentrancy involving the attacker executing malicious code <em>within a single transaction</em>. The following are a different type of attack inherent to Blockchains: the fact that <em>the order of transactions themselves</em> (e.g. within a block) is easily subject to manipulation.</p>
<p>Since a transaction is in the mempool for a short while, one can know what actions will occur before it is included in a block. This can be troublesome for things like decentralized markets, where a transaction to buy some tokens can be seen, and a market order implemented before the other transaction gets included. Protecting against this is difficult, as it would come down to the specific contract itself. For example, in markets, it would be better to implement batch auctions (this also protects against high frequency trading concerns). Another way to use a pre-commit scheme (“I’m going to submit the details later”).</p>
<hr />
<h2 id="timestamp-dependence">Timestamp Dependence<a class="headerlink" href="#timestamp-dependence" title="Permanent link">&para;</a></h2>
<p>Be aware that the timestamp of the block can be manipulated by the miner, and all direct and indirect uses of the timestamp should be considered.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See the <a href="../recommendations/#timestamp-dependence">Recommendations</a> section for design considerations related to Timestamp Dependence.</p>
</div>
<hr />
<h2 id="integer-overflow-and-underflow">Integer Overflow and Underflow<a class="headerlink" href="#integer-overflow-and-underflow" title="Permanent link">&para;</a></h2>
<p>Consider a simple token transfer:</p>
<div class="highlight"><pre><span></span><span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="kr">public</span> <span class="n">balanceOf</span><span class="p">;</span>

<span class="c1">// INSECURE</span>
<span class="kd">function</span> <span class="n">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Check if sender has balance */</span>
    <span class="n">require</span><span class="p">(</span><span class="n">balanceOf</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">_value</span><span class="p">);</span>
    <span class="cm">/* Add and subtract new balances */</span>
    <span class="n">balanceOf</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">_value</span><span class="p">;</span>
    <span class="n">balanceOf</span><span class="p">[</span><span class="n">_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// SECURE</span>
<span class="kd">function</span> <span class="n">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Check if sender has balance and for overflows */</span>
    <span class="n">require</span><span class="p">(</span><span class="n">balanceOf</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">_value</span> <span class="o">&amp;&amp;</span> <span class="n">balanceOf</span><span class="p">[</span><span class="n">_to</span><span class="p">]</span> <span class="o">+</span> <span class="n">_value</span> <span class="o">&gt;=</span> <span class="n">balanceOf</span><span class="p">[</span><span class="n">_to</span><span class="p">]);</span>

    <span class="cm">/* Add and subtract new balances */</span>
    <span class="n">balanceOf</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">_value</span><span class="p">;</span>
    <span class="n">balanceOf</span><span class="p">[</span><span class="n">_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_value</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>If a balance reaches the <em>maximum uint value (2^256)</em> it will circle back to zero which checks for the condition. This may or may not be relevant, depending on the implementation. Think about whether or not the <code>uint</code> value has an opportunity to approach such a large number. Think about how the <code>uint</code> variable changes state, and who has authority to make such changes. If any user can call functions which update the <code>uint</code> value, it's more vulnerable to attack. If only an admin has access to change the variable's state, you might be safe. If a user can increment by only 1 at a time, you are probably also safe because there is no feasible way to reach this limit.</p>
<p>The same is true for underflow. If a uint is made to be less than zero, it will cause an underflow and get set to its maximum value.</p>
<p>Be careful with the smaller data-types like uint8, uint16, uint24...etc: they can even more easily hit their maximum value.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Be aware there are around <a href="https://github.com/ethereum/solidity/issues/796#issuecomment-253578925">20 cases for overflow and underflow</a>.</p>
</div>
<p>One simple solution to mitigate the common mistakes for overflow and underflow is to use <code>SafeMath.sol</code> <a href="https://github.com/OpenZeppelin/openzeppelin-solidity/blob/master/contracts/math/SafeMath.sol">library</a> for arithmetic functions.</p>
<h3 id="underflow-in-depth-storage-manipulation">Underflow in Depth: Storage Manipulation<a class="headerlink" href="#underflow-in-depth-storage-manipulation" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/Arachnid/uscc/tree/master/submissions-2017/doughoyte">Doug Hoyte's submission</a> to the 2017 underhanded solidity contest received <a href="http://u.solidity.cc/">an honorable mention</a>. The entry is interesting, because it raises the concerns about how C-like underflow might affect Solidity storage. Here is a simplified version:</p>
<div class="highlight"><pre><span></span><span class="kd">contract</span> <span class="n">UnderflowManipulation</span> <span class="p">{</span>
    <span class="kt">address</span> <span class="kr">public</span> <span class="n">owner</span><span class="p">;</span>
    <span class="kt">uint256</span> <span class="kr">public</span> <span class="n">manipulateMe</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="kd">function</span> <span class="n">UnderflowManipulation</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">owner</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">uint</span><span class="p">[]</span> <span class="kr">public</span> <span class="n">bonusCodes</span><span class="p">;</span>

    <span class="kd">function</span> <span class="n">pushBonusCode</span><span class="p">(</span><span class="kt">uint</span> <span class="n">code</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bonusCodes</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">popBonusCode</span><span class="p">()</span>  <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="n">bonusCodes</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>  <span class="c1">// this is a tautology</span>
        <span class="n">bonusCodes</span><span class="p">.</span><span class="n">length</span><span class="o">--</span><span class="p">;</span> <span class="c1">// an underflow can be caused here</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">modifyBonusCode</span><span class="p">(</span><span class="kt">uint</span> <span class="n">index</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">update</span><span class="p">)</span>  <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">bonusCodes</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
        <span class="n">bonusCodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">update</span><span class="p">;</span> <span class="c1">// write to any index less than bonusCodes.length</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>

<p>In general, the variable <code>manipulateMe</code>'s location cannot be influenced without going through the <code>keccak256</code>, which is infeasible. However, since dynamic arrays are stored sequentially, if a malicious actor wanted to change <code>manipulateMe</code> all they would need to do is:</p>
<ul>
<li>Call <code>popBonusCode</code> to underflow (Note: <code>array.pop()</code> method <a href="https://github.com/ethereum/solidity/blob/v0.5.0/Changelog.md">was added</a> in Solidity 0.5.0)</li>
<li>Compute the storage location of <code>manipulateMe</code></li>
<li>Modify and update <code>manipulateMe</code>'s value using <code>modifyBonusCode</code></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In practice, this array would be immediately pointed out as fishy, but buried under more complex smart contract architecture, it can arbitrarily allow malicious changes to constant variables, such as total supply of a token.</p>
</div>
<p>When considering use of a dynamic array, a container data scructure is a good practice. The Solidity CRUD <a href="https://medium.com/@robhitchens/solidity-crud-part-1-824ffa69509a">part 1</a> and <a href="https://medium.com/@robhitchens/solidity-crud-part-2-ed8d8b4f74ec">part 2</a> articles are good resources.</p>
<hr />
<p><a name="dos-with-unexpected-revert"></a></p>
<h2 id="dos-with-unexpected-revert">DoS with (Unexpected) revert<a class="headerlink" href="#dos-with-unexpected-revert" title="Permanent link">&para;</a></h2>
<p>Consider a simple auction contract:</p>
<div class="highlight"><pre><span></span><span class="c1">// INSECURE</span>
<span class="kd">contract</span> <span class="n">Auction</span> <span class="p">{</span>
    <span class="kt">address</span> <span class="n">currentLeader</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="n">highestBid</span><span class="p">;</span>

    <span class="kd">function</span> <span class="n">bid</span><span class="p">()</span> <span class="kr">payable</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">highestBid</span><span class="p">);</span>

        <span class="n">require</span><span class="p">(</span><span class="n">currentLeader</span><span class="p">.</span><span class="nb">send</span><span class="p">(</span><span class="n">highestBid</span><span class="p">));</span> <span class="c1">// Refund the old leader, if it fails then revert</span>

        <span class="n">currentLeader</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
        <span class="n">highestBid</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>If attacker bids using a smart contract which has a fallback function that reverts any payment, the attacker can win any auction. When it tries to refund the old leader, it reverts if the refund fails. This means that a malicious bidder can become the leader while making sure that any refunds to their address will <em>always</em> fail. In this way, they can prevent anyone else from calling the <code>bid()</code> function, and stay the leader forever. A recommendation is to set up a <a href="../recommendations#favor-pull-over-push-for-external-calls">pull payment system</a> instead, as described earlier.</p>
<p>Another example is when a contract may iterate through an array to pay users (e.g., supporters in a crowdfunding contract). It's common to want to make sure that each payment succeeds. If not, one should revert. The issue is that if one call fails, you are reverting the whole payout system, meaning the loop will never complete. No one gets paid because one address is forcing an error.</p>
<div class="highlight"><pre><span></span><span class="kt">address</span><span class="p">[]</span> <span class="kr">private</span> <span class="n">refundAddresses</span><span class="p">;</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">public</span> <span class="n">refunds</span><span class="p">;</span>

<span class="c1">// bad</span>
<span class="kd">function</span> <span class="n">refundAll</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">uint</span> <span class="n">x</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">refundAddresses</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// arbitrary length iteration based on how many addresses participated</span>
        <span class="n">require</span><span class="p">(</span><span class="n">refundAddresses</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="nb">send</span><span class="p">(</span><span class="n">refunds</span><span class="p">[</span><span class="n">refundAddresses</span><span class="p">[</span><span class="n">x</span><span class="p">]]))</span> <span class="c1">// doubly bad, now a single failure on send will hold up all funds</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Again, the recommended solution is to <a href="../recommendations#favor-pull-over-push-for-external-calls">favor pull over push payments</a>.</p>
<hr />
<h2 id="dos-with-block-gas-limit">DoS with Block Gas Limit<a class="headerlink" href="#dos-with-block-gas-limit" title="Permanent link">&para;</a></h2>
<p>Each block has an upper bound on the amount of gas that can be spent, and thus the amount computation that can be done. This is the Block Gas Limit. If the gas spent exceeds this limit, the transaction will fail. This leads to a couple possible Denial of Service vectors:</p>
<h3 id="gas-limit-dos-on-a-contract-via-unbounded-operations">Gas Limit DoS on a Contract via Unbounded Operations<a class="headerlink" href="#gas-limit-dos-on-a-contract-via-unbounded-operations" title="Permanent link">&para;</a></h3>
<p>You may have noticed another problem with the previous example: by paying out to everyone at once, you risk running into the block gas limit.</p>
<p>This can lead to problems even in the absence of an intentional attack. However, it's especially bad if an attacker can manipulate the amount of gas needed. In the case of the previous example, the attacker could add a bunch of addresses, each of which needs to get a very small refund. The gas cost of refunding each of the attacker's addresses could, therefore, end up being more than the gas limit, blocking the refund transaction from happening at all.</p>
<p>This is another reason to <a href="../recommendations#favor-pull-over-push-for-external-calls">favor pull over push payments</a>.</p>
<p>If you absolutely must loop over an array of unknown size, then you should plan for it to potentially take multiple blocks, and therefore require multiple transactions. You will need to keep track of how far you've gone, and be able to resume from that point, as in the following example:</p>
<div class="highlight"><pre><span></span><span class="kd">struct</span> <span class="n">Payee</span> <span class="p">{</span>
    <span class="kt">address</span> <span class="n">addr</span><span class="p">;</span>
    <span class="kt">uint256</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Payee</span><span class="p">[]</span> <span class="n">payees</span><span class="p">;</span>
<span class="kt">uint256</span> <span class="n">nextPayeeIndex</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">payOut</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">i</span> <span class="o">=</span> <span class="n">nextPayeeIndex</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">payees</span><span class="p">.</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="nb">msg</span><span class="p">.</span><span class="n">gas</span> <span class="o">&gt;</span> <span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">payees</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">.</span><span class="nb">send</span><span class="p">(</span><span class="n">payees</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">nextPayeeIndex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>You will need to make sure that nothing bad will happen if other transactions are processed while waiting for the next iteration of the <code>payOut()</code> function. So only use this pattern if absolutely necessary.</p>
<h3 id="gas-limit-dos-on-the-network-via-block-stuffing">Gas Limit DoS on the Network via Block Stuffing<a class="headerlink" href="#gas-limit-dos-on-the-network-via-block-stuffing" title="Permanent link">&para;</a></h3>
<p>Even if your contract does not contain an unbounded loop, an attacker can prevent other transactions from being included in the blockchain for several blocks by placing computationally intensive transactions with a high enough gas price.</p>
<p>To do this, the attacker can issue several transactions which will consume the entire gas limit, with a high enough gas price to be included as soon as the next block is mined. No gas price can guarantee inclusion in the block, but the higher the price is, the higher is the chance.</p>
<p>If the attack succeeds, no other transactions will be included in the block. Sometimes, an attacker's goal is to block transactions to a specific contract prior to specific time.</p>
<p>This attack <a href="https://osolmaz.com/2018/10/18/anatomy-block-stuffing">was conducted</a> on Fomo3D, a gambling app. The app was designed to reward the last address that purchased a "key". Each key purchase extended the timer, and the game ended once the timer went to 0. The attacker bought a key and then stuffed 13 blocks in a row until the timer was triggered and the payout was released. Transactions sent by attacker took 7.9 million gas on each block, so the gas limit allowed a few small "send" transactions (which take 21,000 gas each), but disallowed any calls to the <code>buyKey()</code> function (which costs 300,000+ gas).</p>
<p>A Block Stuffing attack can be used on any contract requiring an action within a certain time period. However, as with any attack, it is only profitable when the expected reward exceeds its cost. Cost of this attack is directly proportional to the number of blocks which need to be stuffed. If a large payout can be obtained by preventing actions from other participants, your contract will likely be targeted by such an attack.</p>
<hr />
<h2 id="insufficient-gas-griefing">Insufficient gas griefing<a class="headerlink" href="#insufficient-gas-griefing" title="Permanent link">&para;</a></h2>
<p>This attack may be possible on a contract which accepts generic data and uses it to make a call another contract (a 'sub-call') via the low level <code>address.call()</code> function, as is often the case with multisignature and transaction relayer contracts.</p>
<p>If the call fails, the contract has two options:</p>
<ol>
<li>revert the whole transaction</li>
<li>continue execution.</li>
</ol>
<p>Take the following example of a simplified <code>Relayer</code> contract which continues execution regardless of the outcome of the subcall:</p>
<div class="highlight"><pre><span></span><span class="kd">contract</span> <span class="n">Relayer</span> <span class="p">{</span>
    <span class="kd">mapping</span> <span class="p">(</span><span class="kt">bytes</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">)</span> <span class="n">executed</span><span class="p">;</span>

    <span class="kd">function</span> <span class="n">relay</span><span class="p">(</span><span class="kt">bytes</span> <span class="n">_data</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="c1">// replay protection; do not call the same transaction twice</span>
        <span class="n">require</span><span class="p">(</span><span class="n">executed</span><span class="p">[</span><span class="n">_data</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Duplicate call&quot;</span><span class="p">);</span>
        <span class="n">executed</span><span class="p">[</span><span class="n">_data</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="n">innerContract</span><span class="p">.</span><span class="nb">call</span><span class="p">(</span><span class="kt">bytes4</span><span class="p">(</span><span class="n">keccak256</span><span class="p">(</span><span class="s">&quot;execute(bytes)&quot;</span><span class="p">)),</span> <span class="n">_data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>This contract allows transaction relaying. Someone who wants to make a transaction but can't execute it by himself (e.g. due to the lack of ether to pay for gas) can sign data that he wants to pass and transfer the data with his signature over any medium. A third party "forwarder" can then submit this transaction to the network on behalf of the user.</p>
<p>If given just the right amount of gas, the <code>Relayer</code> would complete execution recording the <code>_data</code>argument in the <code>executed</code> mapping, but the subcall would fail because it received insufficient gas to complete execution.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When a contract makes a sub-call to another contract, the EVM limits the gas forwarded to <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-150.md">to 63/64 of the remaining gas</a>,</p>
</div>
<p>An attacker can use this to censor transactions, causing them to fail by sending them with a low amount of gas. This attack is a form of "<a href="https://en.wikipedia.org/wiki/Griefer">griefing</a>": It doesn't directly benefit the attacker, but causes grief for the victim. A dedicated attacker, willing to consistently spend a small amount of gas could theoretically censor all transactions this way, if they were the first to submit them to <code>Relayer</code>.</p>
<p>One way to address this is to implement logic requiring forwarders to provide enough gas to finish the subcall. If the miner tried to conduct the attack in this scenario, the <code>require</code> statement would fail and the inner call would revert. A user can specify a minimum gasLimit along with the other data (in this example, typically the <code>_gasLimit</code> value would be verified by a signature, but that is ommitted for simplicity in this case).</p>
<div class="highlight"><pre><span></span><span class="c1">// contract called by Relayer</span>
<span class="kd">contract</span> <span class="n">Executor</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="n">execute</span><span class="p">(</span><span class="kt">bytes</span> <span class="n">_data</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">_gasLimit</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="n">gasleft</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">_gasLimit</span><span class="p">);</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Another solution is to permit only trusted accounts to relay the transaction.</p>
<hr />
<h2 id="forcibly-sending-ether-to-a-contract">Forcibly Sending Ether to a Contract<a class="headerlink" href="#forcibly-sending-ether-to-a-contract" title="Permanent link">&para;</a></h2>
<p>It is possible to forcibly send Ether to a contract without triggering its fallback function. This is an important consideration when placing important logic in the fallback function or making calculations based on a contract's balance. Take the following example:</p>
<div class="highlight"><pre><span></span><span class="kd">contract</span> <span class="n">Vulnerable</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="p">()</span> <span class="kr">payable</span> <span class="p">{</span>
        <span class="n">revert</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">somethingBad</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="nb">this</span><span class="p">.</span><span class="nb">balance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
        <span class="c1">// Do something bad</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Contract logic seems to disallow payments to the contract and therefore disallow "something bad" from happening. However, a few methods exist for forcibly sending ether to the contract and therefore making its balance greater than zero.</p>
<p>The <code>selfdestruct</code> contract method allows a user to specify a beneficiary to send any excess ether. <code>selfdestruct</code> <a href="https://solidity.readthedocs.io/en/develop/security-considerations.html#sending-and-receiving-ether">does not trigger a contract's fallback function</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is also possible to <a href="https://github.com/Arachnid/uscc/tree/master/submissions-2017/ricmoo">precompute</a> a contract's address and send Ether to that address before deploying the contract.</p>
</div>
<hr />
<h2 id="deprecatedhistorical-attacks">Deprecated/historical attacks<a class="headerlink" href="#deprecatedhistorical-attacks" title="Permanent link">&para;</a></h2>
<p>These are attacks which are no longer possible due to changes in the protocol or improvements to solidity. They are recorded here for posterity and awareness.</p>
<h3 id="call-depth-attack-deprecated">Call Depth Attack (deprecated)<a class="headerlink" href="#call-depth-attack-deprecated" title="Permanent link">&para;</a></h3>
<p>As of the <a href="https://github.com/ethereum/EIPs/issues/150">EIP 150</a> hardfork, call depth attacks are no longer relevant<sup><a href='http://ethereum.stackexchange.com/questions/9398/how-does-eip-150-change-the-call-depth-attack'>*</a></sup> (all gas would be consumed well before reaching the 1024 call depth limit).</p>
<h3 id="constantinople-reentrancy-attack">Constantinople Reentrancy Attack<a class="headerlink" href="#constantinople-reentrancy-attack" title="Permanent link">&para;</a></h3>
<p>On January 16<sup>th</sup>, 2019, Constantinople protocol upgrade was delayed due to a security vulnerability enabled by <a href="https://eips.ethereum.org/EIPS/eip-1283">EIP 1283</a>. <em>EIP 1283: Net gas metering for SSTORE without dirty maps</em> proposes changes to reduce excessive gas costs on dirty storage writes.</p>
<p>This change led to possibility of a new reentrancy vector making previously known secure withdrawal patterns (<code>.send()</code> and <code>.transfer()</code>) unsafe in specific situations<sup><a href='https://medium.com/chainsecurity/constantinople-enables-new-reentrancy-attack-ace4088297d9'>*</a></sup>, where the attacker could hijack the control flow and use the remaining gas enabled by EIP 1283, leading to vulnerabilities due to reentrancy.</p>
<h2 id="other-vulnerabilities">Other Vulnerabilities<a class="headerlink" href="#other-vulnerabilities" title="Permanent link">&para;</a></h2>
<p>The <a href="https://smartcontractsecurity.github.io/SWC-registry/">Smart Contract Weakness Classification Registry</a> offers a complete and up-to-date catalogue of known smart contract vulnerabilities and anti-patterns along with real-world examples. Browsing the registry is a good way of keeping up-to-date with the latest attacks.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->



<!-- Application footer -->
<footer class="md-footer">

  <!-- Link to previous and/or next page -->
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">

        <!-- Link to previous page -->
        
          <a href="../recommendations/"
              title="Solidity Recommendations"
              class="md-flex md-footer-nav__link md-footer-nav__link--prev"
              rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back
                    md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch
                  md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Solidity Recommendations
              </span>
            </div>
          </a>
        

        <!-- Link to next page -->
        
          <a href="../software_engineering/" title="Software Engineering Techniques"
              class="md-flex md-footer-nav__link md-footer-nav__link--next"
              rel="next">
            <div class="md-flex__cell md-flex__cell--stretch
                  md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Software Engineering Techniques
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward
                    md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  

  <!-- Further information -->
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">

      <!-- Copyright and theme information -->
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>

      <!-- Customization: Diligence info -->
      <div class="md-footer-diligence">

        maintained by
        <a href="https://diligence.consensys.net" target="_blank" rel="noopener">
          <img src="../assets/images/diligence_logo.svg" />
          ConsenSys Diligence
        </a>
      </div>

      <!-- Social links -->
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.6cdc17f0.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>